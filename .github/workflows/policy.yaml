name: policy

on:
  push:

env:
  IMAGE: harbor.rode.lead.prod.liatr.io/rode-demo/rode-demo-node-app
  RODE_HOST: rode.rode-demo.svc.cluster.local:50051

jobs:
  evaluate:
    runs-on:
      - self-hosted
      - rode-runners-prod
    steps:
      - name: Get Resource URI
        id: get
        run: |
          digest=$(awk '/tag/{print $2}'  env-values.yaml)
          echo "Found digest: $digest"
          resourceUri="${{ env.IMAGE }}@sha256:$digest"
          echo "Resource uri: $resourceUri"
          echo "::set-output name=resoureUri::$resourceUri"

      - name: Evaluate Policy
        id: policy
        uses: rode/evaluate-policy-action@v0.1.0
        with:
          enforce: true
          policyName: Sample Harbor Policy
          resourceUri: ${{ steps.get.outputs.resourceUri }}
          rodeHost: ${{ env.RODE_HOST }}
          rodeInsecure: true
