name: pr

on:
  pull_request:
    branches:
      - dev
      - staging
      - prod

env:
  IMAGE: harbor.test/rode-demo/rode-demo-node-app@sha256:cc723cb3075eb2d7c855f2351cfaedf67830577f6321f92b0ae5f83701e7552b
  RODE_HOST: rode.rode-demo.svc.cluster.local:50051
  OAUTH2_TOKEN_URL: 'https://keycloak.internal.lead.prod.liatr.io/auth/realms/rode-demo/protocol/openid-connect/token'
  OAUTH2_CLIENT_ID: rode-enforcer
  SNOW_URL: https://dev112050.service-now.com
  SNOW_USERNAME: admin

jobs:
  evaluate:
    runs-on:
      - self-hosted
      - rode-runners-prod
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Create Change Request
        uses: liatrio/github-actions/snow-change-request@snow
        id: cr
        with:
          action: create
          changeRequestMessage: "Deploy demo-app"
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          serviceNowUrl: ${{ env.SNOW_URL }}
          serviceNowUsername: ${{ env.SNOW_USERNAME }}
          serviceNowPassword: ${{ secrets.SNOW_PASSWORD }}

      - name: Evaluate Resource
        uses: rode/evaluate-policy-action@output-report
        id: evaluation
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          enforce: true
          policyGroup: rode-demo
          resourceUri: ${{ env.IMAGE }}
          rodeHost: ${{ env.RODE_HOST }}
          rodeInsecure: true

      - name: Attach Evaluation Summary
        uses: liatrio/github-actions/snow-change-request@snow
        with:
          action: attach-file
          attachmentFilePath: ${{ steps.evaluation.outputs.reportPath }}
          requestSysId: ${{ steps.cr.outputs.sysId }}
          serviceNowUrl: ${{ env.SNOW_URL }}
          serviceNowUsername: ${{ env.SNOW_USERNAME }}
          serviceNowPassword: ${{ secrets.SNOW_PASSWORD }}
