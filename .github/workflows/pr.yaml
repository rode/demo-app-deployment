name: pr

on:
  pull_request:
    branches:
      - dev
      - staging
      - prod

env:
  IMAGE: harbor.internal.lead.prod.liatr.io/rode-demo/rode-demo-node-app
#  RODE_HOST: rode.rode-demo.svc.cluster.local:50051
  RODE_HOST: 2.tcp.ngrok.io:13623
#  OAUTH2_TOKEN_URL: 'https://keycloak.internal.lead.prod.liatr.io/auth/realms/rode-demo/protocol/openid-connect/token'
  OAUTH2_TOKEN_URL: 'https://aha-keycloak.ngrok.io/auth/realms/rode-demo/protocol/openid-connect/token'
  OAUTH2_CLIENT_ID: rode-enforcer

jobs:
  evaluate:
    runs-on:
      - self-hosted
      - rode-runners-prod
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Get Resource URI
        id: get
        run: |
#          digest=$(awk '/tag/{print $2}' env-values.yaml)
#          resourceUri="${{ env.IMAGE }}@sha256:$digest"
          resourceUri="harbor.local/rode-demo/alpine@sha256:1775bebec23e1f3ce486989bfc9ff3c4e951690df84aa9f926497d82f2ffca9d"
          echo "::set-output name=resourceUri::$resourceUri"

      - name: Fetch Access Token
        uses: liatrio/github-actions/oauth2-token@master
        id: token
        with:
          clientId: ${{ env.OAUTH2_CLIENT_ID }}
          clientSecret: ${{ secrets.CLIENT_SECRET }}
          tokenUrl: ${{ env.OAUTH2_TOKEN_URL }}

      - name: Evaluate Policy
        id: policy
        uses: rode/evaluate-policy-action@eval-resource
        with:
          accessToken: ${{ steps.token.outputs.accessToken }}
          enforce: ${{ github.base_ref != 'dev' }} # don't require policy to pass when a PR targets dev
          policyGroup: rode-demo
          resourceUri: ${{ steps.get.outputs.resourceUri }}
          rodeHost: ${{ env.RODE_HOST }}
          rodeInsecure: true
